<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.mapper.ScribbleMapper">
	<resultMap type="TagVO" id="tagVO">
		<result column="tname" property="tname"/>
	</resultMap>
	
	<resultMap type="ScribbleVO" id="ScribbleListMap">
		<result column="sno" property="sno" />
		<result column="sdate" property="sdate" />
		<result column="srate" property="srate" />
		<result column="spublishdate" property="spublishdate"/>
		<association property="fvo" javaType="FilmVO">
			<result column="fname" property="fname"/>
			<result column="fimg" property="fimg"/>
		</association>
		<association property="kvo" javaType="KinoVO">
			<result column="kname" property="kname"/>
		</association>
		<collection property="tags" resultMap="tagVO"/>
	</resultMap>
	
	<resultMap type="ScribbleVO" id="ScribbleDetailMap">
		<result column="sno" property="sno" />
		<result column="sdate" property="sdate" />
		<result column="srate" property="srate" />
		<result column="scontent" property="scontent" />
		<association property="fvo" javaType="FilmVO">
			<result column="fname" property="fname"/>
			<result column="fimg" property="fimg"/>
			<result column="frelease" property="frelease"/>
			<result column="fdirector" property="fdirector"/>
			<result column="fcast" property="fcast"/>
		</association>
		<association property="kvo" javaType="KinoVO">
			<result column="kname" property="kname"/>
		</association>
		<collection property="tags" resultMap="tagVO"/>
	</resultMap>
	
	<insert id="insertScribble">
		INSERT INTO scribbles
		(sdate, uno, fcode, kcode, srate, scontent, sip)
		VALUES
		(#{sdate}, #{uno}, #{fcode}, #{kcode}, #{srate}, #{scontent}, #{sip})
		<selectKey keyProperty="sno" resultType="integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<select id="listScribble" parameterType="SearchVO" resultMap="ScribbleListMap">
		SELECT s.sno, s.sdate, s.srate, f.fname, f.fimg, k.kname, s.spublishdate, tl.tname
		FROM scribbles as s
		JOIN films as f ON s.fcode=f.fcode
		JOIN kinos as k ON s.kcode=k.kcode
		JOIN tags as t ON s.sno=t.sno
		LEFT JOIN tag_library as tl ON t.tid=tl.tid
		WHERE s.uno=#{uno}
		<if test='option != null and keyword != null'>
			<choose>
			<when test='option eq "fname"'>
				AND f.fname LIKE CONCAT('%', #{keyword}, '%')
			</when>
			<when test='option eq "kname"'>
				AND k.kname LIKE CONCAT('%', #{keyword}, '%')
			</when>
			<when test='option eq "tname"'>
				AND tl.tname LIKE CONCAT('%', #{keyword}, '%')
			</when>
		</choose>
		</if>
		<choose>
			<when test='order eq "lat"'> ORDER BY sno DESC </when>
			<when test='order eq "old"'> ORDER BY sno ASC </when>
			<when test='order eq "hig"'> ORDER BY srate DESC </when>
			<when test='order eq "low"'> ORDER BY srate ASC </when>
			<otherwise> ORDER BY sno DESC </otherwise>
		</choose>
		LIMIT #{startNum}, #{pageLmt}
	</select>
	
	<select id="detailScribble" parameterType="integer" resultMap="ScribbleDetailMap">
		SELECT f.fimg, f.fname, k.kname, s.sdate, s.srate, s.scontent, f.frelease, f.fdirector, f.fcast, tl.tname
		FROM scribbles as s
		JOIN films as f ON s.fcode=f.fcode
		JOIN kinos as k ON s.kcode=k.kcode
		JOIN tags as t ON s.sno=t.sno
		LEFT JOIN tag_library as tl ON t.tid=tl.tid
		WHERE s.uno=#{param1} AND s.sno=#{param2}
	</select>
</mapper>